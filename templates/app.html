ƒ<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Air Quality & Data Centers Map</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdn.jsdelivr.net/npm/daisyui@3.3.1/dist/full.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

<style>
html, body { height:100%; margin:0; font-family:'Inter',sans-serif; overflow:hidden; background:#111827; }
#map {
  position: absolute;
  top: 120px; /* was 100px, give extra space */
  bottom: 0;
  right: 0;
  left: 0;
}

/* Monitor Panel */
#monitor-panel {
  position:absolute; top:50%; left:10px; transform:translateY(-50%);
  background:rgba(30,41,59,0.95); color:#fff; padding:12px 16px;
  border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.5); z-index:500;
  font-size:0.9rem; display:flex; flex-direction:column; gap:4px;
}

#map-info-box {
  position: absolute;
  top: 80px;      /* adjust for header */
  right: 15px;
  width: 340px;
  background: rgba(30, 41, 59, 0.95);
  color: #f0f0f0;
  padding: 18px 20px;
  border-radius: 16px;
  box-shadow: 0 12px 28px rgba(0,0,0,0.6);
  font-size: 0.92rem;
  line-height: 1.5rem;
  z-index: 520;
  transition: all 0.3s ease;
}

#map-info-box strong {
  color: #6EC1E4;
}

#map-info-box div {
  margin-bottom: 10px;
}

#map-info-box:hover {
  transform: translateY(-2px);
  box-shadow: 0 16px 32px rgba(0,0,0,0.65);
}


/* Data Center Info Tab - Small */
#dc-info-tab {
  position: absolute;
  top: calc(50% - 200px);
  left: 10px;
  transform: translateY(-50%);
  background: rgba(15, 42, 66, 0.95);
  color: #fff;
  padding: 16px 20px;
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
  z-index: 510;
  width: 260px;           /* slightly bigger */
  display: none;
  flex-direction: column;
  gap: 10px;
  font-size: 0.9rem;
  cursor: pointer;
}

#dc-info-tab div {
  display: flex;
  align-items: center;
  gap: 8px;
}

#dc-info-tab .dc-icon-small {
  width: 22px;            /* bigger icon container */
  display: inline-block;
  text-align: center;
}

#dc-info-tab .dc-icon-small i {
  font-size: 18px;        /* slightly larger icons */
}

/* Data Center Info Tab - Expanded / Large */
#dc-info-tab.large {
  width: 420px;
  height: 520px;
  top: 50px;
  left: 50%;
  transform: translateX(-50%);
  overflow-y: auto;
  font-size: 1rem;
  padding: 24px;
  flex-direction: column;
  gap: 14px;
  cursor: default;
}

/* Close Button */
#dc-info-tab #close-dc-tab {
  align-self: flex-end;
  background: transparent;
  border: none;
  color: #fff;
  font-size: 1.4rem;
  cursor: pointer;
}
/* More Insights panel for Water */
#more-insights {
  position:absolute;
  top:50%;
  left:10px;
  transform:translateY(-50%);
  background:rgba(30,41,59,0.95);
  color:#fff;
  padding:10px 12px;
  border-radius:10px;
  box-shadow:0 8px 20px rgba(0,0,0,0.5);
  z-index:510;
  display:none;
  flex-direction:column;
  gap:8px;
  font-size:0.85rem;
}
#more-insights .insight-item { cursor:pointer; display:flex; align-items:center; gap:6px; }

/* Central Graph Panel (Water vs Carbon) */
#insight-graph-panel {
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%, -50%);
  width:80vw;       /* increased width relative to viewport */
  height:70vh;      /* increased height relative to viewport */
  max-width:1200px; /* optional max limits */
  max-height:900px;
  background:rgba(15,42,66,0.95);
  border-radius:12px;
  box-shadow:0 8px 20px rgba(0,0,0,0.5);
  color:#fff;
  display:none;
  flex-direction:column;
  z-index:600;
  padding:20px;
  overflow:auto;     /* allow scrolling if needed */
}

/* Graph placeholder fills the panel */
#graph-placeholder {
  flex:1;
  display:flex;
  align-items:center;
  justify-content:center;
  border:2px dashed #6EC1E4;
  color:#6EC1E4;
  width:100%;
  height:100%;
}

/* Inner canvas fills placeholder */
#graph-placeholder canvas {
  width:100% !important;
  height:100% !important;
}

/* Carbon Projection Modal */
#carbon-projection-modal {
  display: none;             /* Hidden initially */
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 600px;
  height: 400px;
  background: rgba(15,42,66,0.95);
  border-radius: 12px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.5);
  color: #fff;
  z-index: 600;
  padding: 20px;
  flex-direction: column;
}

/* Make the chart canvas fill the modal */
#carbonProjectionChart {
  flex: 1;              /* Fill the parent container */
  width: 100% !important;
  height: 100% !important;
}

/* Footer & Ribbon */
#footer-timestamp { position:absolute; bottom:10px; right:15px; background:rgba(30,41,59,0.85); padding:6px 12px;
  border-radius:10px; color:#f0f0f0; font-size:0.8rem; box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:500; }

/* Title Ribbon */
#title-ribbon {
  height: 60px; /* taller */
  line-height: 60px; /* vertically center text */
  font-size: 1.8rem; /* bigger text */
  font-weight: 700;
  background: linear-gradient(to right,#0f2b42,#1a3c54);
  text-align: center;
  color: #e0e0e0;
}

/* Navigation Ribbon */
#nav-ribbon {
  height: 60px; /* taller */
  line-height: 60px; /* vertically center items */
  background: #1a3c54;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 20px;
}

.nav-item {
  font-size: 1.1rem; /* slightly bigger nav options */
  padding: 0 18px;
  line-height: 60px; /* match ribbon height */
}
.nav-item:hover { background:rgba(255,255,255,0.1); border-radius:6px; }
.nav-item.active { border-bottom:3px solid #6EC1E4; }

.legend { position:absolute; bottom:10px; left:10px; background:rgba(30,41,59,0.9); color:#fff;
  padding:10px; border-radius:8px; font-size:0.8rem; box-shadow:0 4px 10px rgba(0,0,0,0.3); z-index:500; }
.legend div { display:flex; align-items:center; margin-bottom:4px; }
.legend span { display:inline-block; width:16px; height:16px; margin-right:6px; border-radius:4px; }

#hover-aqi { position:absolute; pointer-events:none; padding:6px 10px; background:rgba(30,41,59,0.9);
  color:#fff; border-radius:8px; font-size:0.85rem; z-index:600; display:none; }

.dc-icon i { pointer-events:none; }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<div id="header-wrapper">
  <div id="title-ribbon">Environmental Impact of Data Centers</div>
  <div id="nav-ribbon">
    <div class="flex gap-3">
      <div class="nav-item active" data-layer="air">Air Quality</div>
      <div class="nav-item" data-layer="water">Water</div>
      <div class="nav-item" data-layer="power">Power</div>
      <div class="nav-item" data-layer="co2">CO2</div>
    </div>
  </div>
</div>

<!-- DC Info Tab -->
<div id="dc-info-tab">
  <button id="close-dc-tab">✖</button>

  <div>
    <span class="dc-icon-small"><i class="fas fa-database" style="color:cyan;"></i></span>
    <strong id="dc-name">DC Name</strong>
  </div>
  <div>
    <span class="dc-icon-small"><i class="fas fa-layer-group" style="color:#6EC1E4;"></i></span>
    <strong>SizeRank:</strong> <span id="dc-size">N/A</span>
  </div>
  <div>
    <span class="dc-icon-small"><i class="fas fa-bolt" style="color:#FACC15;"></i></span>
    <strong>Power Source:</strong> <span id="dc-power">N/A</span>
  </div>
  <div>
    <span class="dc-icon-small"><i class="fas fa-snowflake" style="color:#3B82F6;"></i></span>
    <strong>Cooling Source:</strong> <span id="dc-cooling">N/A</span>
  </div>

  <!-- Extra fields in same style -->
  <div>
    <span class="dc-icon-small"><i class="fas fa-building" style="color:#FFD700;"></i></span>
    <strong>Operator:</strong> <span id="dc-operator">N/A</span>
  </div>
  <div>
    <span class="dc-icon-small"><i class="fas fa-city" style="color:#4ADE80;"></i></span>
    <strong>City:</strong> <span id="dc-city">N/A</span>
  </div>
  <div>
    <span class="dc-icon-small"><i class="fas fa-map-marker-alt" style="color:#3B82F6;"></i></span>
    <strong>State:</strong> <span id="dc-state">N/A</span>
  </div>
  <div>
    <span class="dc-icon-small"><i class="fas fa-dollar-sign" style="color:#FACC15;"></i></span>
    <strong>Project Cost:</strong> <span id="dc-cost">N/A</span>
  </div>
  <div>
    <span class="dc-icon-small"><i class="fas fa-info-circle" style="color:#FF6B6B;"></i></span>
    <strong>Status:</strong> <span id="dc-status">N/A</span>
  </div>
</div>

<div id="map-info-box" class="info-box" style="display:none;">
  <div><strong>Map Overview:</strong> The map displays current AQI across locations and data center sites.</div>
  <div><strong>Air Quality (AQI) Layer:</strong> Hover over the map to see the AQI at specific locations. AQI can be viewed for Ozone, PM2.5, PM10, or “Ozone and PM” (the highest NowCast AQI among the three).</div>
  <div><strong>Data Center Layer:</strong> Hover over a data center to view details such as name, size rank, power source, cooling source, operator, city, state, project cost, and status.</div>
  <div><strong>Interactions:</strong> Click a monitor or data center to explore more detailed info. Use the layer options to switch AQI view by pollutant.</div>
</div>



<!-- Monitor Panel -->
<div id="monitor-panel">
  <strong>Monitor Layer</strong>
  <label class="cursor-pointer label">
    <input type="radio" name="monitor-layer" checked class="radio radio-sm mr-2"> Ozone and PM
  </label>
  <label class="cursor-pointer label">
    <input type="radio" name="monitor-layer" class="radio radio-sm mr-2"> Ozone only
  </label>
  <label class="cursor-pointer label">
    <input type="radio" name="monitor-layer" class="radio radio-sm mr-2"> PM2.5 only
  </label>
</div>

<div id="more-insights">
  <strong>More Insights</strong>

  <!-- Existing Fuel Type -->
  <div class="insight-item" data-type="fuel">
    <i class="fas fa-gas-pump" style="color:yellow;"></i> Fuel Type
  </div>

  <!-- Dynamically added Water Projections (via JS) -->
  <div id="water-projection-tab" class="insight-item">
    <i class="fas fa-water" style="color:#3B82F6;"></i> Water Projections
  </div>
</div>

<!-- Carbon Projection Modal -->
<div id="carbon-projection-modal" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
     width:600px; height:400px; background:rgba(15,42,66,0.95); border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.5);
     color:#fff; z-index:600; padding:20px; display:flex; flex-direction:column;">
  <button id="close-carbon-projection" style="align-self:flex-end; background:transparent; border:none; color:#fff; font-size:1.2rem; cursor:pointer;">✖</button>
  <div style="font-weight:600; font-size:1.2rem; margin-bottom:10px;">Carbon Projections</div>
  <canvas id="carbonProjectionChart"></canvas>
</div>



<!-- Central Graph Panel -->
<div id="insight-graph-panel">
  <button id="close-graph-panel">✖</button>
  <div id="graph-title" style="font-weight:600; font-size:1.2rem; margin-bottom:10px;">Fuel Type Analysis</div>
  <div id="graph-placeholder">Graph Placeholder</div>
</div>

<div id="map"></div>

<!-- Water Projection Modal -->
<div id="water-projection-modal" style="display:none; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
     width:600px; height:400px; background:rgba(15,42,66,0.95); border-radius:12px; box-shadow:0 8px 20px rgba(0,0,0,0.5);
     color:#fff; z-index:600; padding:20px; flex-direction:column;">
  <button id="close-water-projection" style="align-self:flex-end; background:transparent; border:none; color:#fff; font-size:1.2rem; cursor:pointer;">✖</button>
  <div style="font-weight:600; font-size:1.2rem; margin-bottom:10px;">Water Projections</div>
  <canvas id="waterProjectionChart" width="560" height="300"></canvas>
</div>


<div id="footer-timestamp">Loading data...</div>
<div id="hover-aqi"></div>
<div class="legend" id="legend"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
const startZoom = 5;
const map = L.map('map', {
    center: [39.5, -98.35],  // center of continental US
    zoom: startZoom,          // starting zoom
    minZoom: startZoom,       // restrict zoom out to starting zoom
    maxZoom: startZoom + 3    // allow zoom in only 3 steps
});

L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
    subdomains: 'abcd',
    maxZoom: 19              // tile layer maxZoom
}).addTo(map);

let currentPollutant = "all";
let monitorData = [];
let waterData = [];
let dcMarkers = [];
let heatLayer = null;
let currentLayer = "air";
let initialLoad = true; // flag for first load
let carbonMarkers = []; // keep track of CO2 circle markers
let waterHeatLayer = null; // add at the top with other globals
let waterMarkers = []; // global
let waterPulseInterval = null; // store interval so we can clear it
let aqiMarkers = []; // track AQI circle markers
let powerData = [];
let powerMarkers = [];
let powerHeatLayer = null;
let powerPulseInterval = null;



// --- Legends ---
function setLegend(layer){
  const legend = document.getElementById('legend');
  legend.innerHTML = '';
  if(layer==='air'){
    legend.innerHTML = `
      <div><span style="background:green"></span>Good</div>
      <div><span style="background:yellow"></span>Moderate</div>
      <div><span style="background:orange"></span>Unhealthy for Sensitive</div>
      <div><span style="background:red"></span>Unhealthy</div>
      <div><span style="background:purple"></span>Very Unhealthy</div>
      <div><span style="background:cyan"></span>Data Center</div>
    `;
  } else if(layer==='water'){
    legend.innerHTML = `
      <div><span style="background:blue"></span>Low footprint</div>
      <div><span style="background:cyan"></span>Moderate</div>
      <div><span style="background:lime"></span>High</div>
      <div><span style="background:yellow"></span>Very High</div>
      <div><span style="background:red"></span>Extreme</div>
      <div><span style="background:cyan"></span>Data Center</div>
    `;
  }
  else if(layer === 'co2'){
  legend.innerHTML = `
    <div><span style="background:#00ff00"></span>Low CO₂</div>
    <div><span style="background:#aaff00"></span>Moderate</div>
    <div><span style="background:#ffff00"></span>High</div>
    <div><span style="background:#ff8800"></span>Very High</div>
    <div><span style="background:#ff0000"></span>Extreme</div>
    <div><span style="background:cyan"></span>Data Center</div>
  `;
}

}

// --- Load Data Centers ---
async function loadDataCenters(){
  try {
    const res = await fetch('https://data-center-map-nu1d.onrender.com/api/monitors');
    const data = await res.json();
    if(!data.data_centers || data.data_centers.length === 0) return;

    // Remove old markers
    dcMarkers.forEach(m => map.removeLayer(m));
    dcMarkers = [];

    data.data_centers.forEach(dc => {
      if(!dc.lat || !dc.lon) return;

      const marker = L.marker([Number(dc.lat), Number(dc.lon)], {
        icon: L.divIcon({
          className:'dc-icon',
          html:`<i class="fas fa-database" style="color:cyan;font-size:12px;"></i>`
        })
      }).addTo(map);

      marker.on('mouseover', ()=> {
        const tab = document.getElementById('dc-info-tab');
        tab.style.display='flex';
        document.getElementById('dc-name').innerText = dc.name || 'N/A';
        document.getElementById('dc-operator').innerText = dc.operator || 'N/A';
        document.getElementById('dc-power').innerText = dc.powerSource || 'N/A';
        document.getElementById('dc-cooling').innerText = dc.coolingSource || 'N/A';
        document.getElementById('dc-city').innerText = dc.city || 'N/A';
        document.getElementById('dc-state').innerText = dc.state || 'N/A';
        document.getElementById('dc-size').innerText = dc.propertySizeAcres || 'N/A';
        document.getElementById('dc-cost').innerText = dc.projectCost || 'N/A';
        document.getElementById('dc-status').innerText = dc.status || 'N/A';
      });

      dcMarkers.push(marker);
    });

    // Fit bounds only after initial load
    if(!initialLoad && dcMarkers.length>0){
      const group = new L.featureGroup(dcMarkers);
      map.fitBounds(group.getBounds().pad(0.2));
    }

    initialLoad = false;

  } catch(err){
    console.error(err);
  }
}


// --- Load AQI Heatmap ---
async function loadAQIHeatmap(){
  try {
    const res = await fetch(`https://data-center-map-nu1d.onrender.com/api/monitors?pollutant=${currentPollutant}`);
    const data = await res.json();
    monitorData = data.monitors||[];

    // --- Remove heatLayer if exists ---
    if(heatLayer){ 
      map.removeLayer(heatLayer); 
      heatLayer=null; 
    }

    // --- HeatLayer (commented out) ---
    
    // const points = monitorData.map(m=>[m.lat, m.lon, Math.min(m.aqi/500,0.6)]);
    // heatLayer = L.heatLayer(points,{
    //   radius:15,
    //   blur:8,
    //   maxZoom:10,
    //   gradient:{0:'green',0.3:'yellow',0.6:'orange',0.8:'red',1:'purple'}
    // }).addTo(map);
    

    // Clear old AQI markers
    aqiMarkers.forEach(m => map.removeLayer(m));
    aqiMarkers = [];

    // Add visible circle markers for AQI
    monitorData.forEach(m => {
      const radius = 5 + m.aqi / 50; // adjust size based on AQI
      const marker = L.circleMarker([m.lat, m.lon], {
        radius: radius,
        fillColor: m.color || 'gray',
        color: m.color || 'gray',
        fillOpacity: 0.6,
        weight: 1
      }).addTo(map)
        .bindTooltip(`AQI: ${m.aqi}`, {direction:'top', className:'aqi-tooltip'});
      aqiMarkers.push(marker);
    });

    document.getElementById('footer-timestamp').innerText = 
      `Updated: ${new Date(data.timestamp).toLocaleString()}`;
    setLegend('air');

  } catch(err){ console.error(err); }
}



async function loadWaterHeatmap() {
  try {
    const res = await fetch('https://data-center-map-nu1d.onrender.com/api/water');
    const data = await res.json();
    waterData = data.points || [];
    if (waterData.length === 0) return;

    // Remove old heat & markers first
    clearWaterLayer();

    const maxFootprint = Math.max(...waterData.map(p => parseFloat(p.water_footprint) || 0));

    // --- HeatLayer commented out ---
    /*
    const heatPoints = waterData.map(p => [p.lat, p.lon, (parseFloat(p.water_footprint)||0) / maxFootprint * 0.02]);
    waterHeatLayer = L.heatLayer(heatPoints, {
      radius: 15,
      blur: 15,
      minOpacity: 0.2,
      gradient: {
        0.0: '#0000ff',
        0.25: '#00ffff',
        0.5: '#00ff00',
        0.75: '#ffff00',
        1.0: '#ff0000'
      }
    }).addTo(map);
    */

    // --- Pulsating Circles (static now) ---
    waterMarkers = []; // reset
    waterData.forEach(p => {
      const intensity = Math.min((parseFloat(p.water_footprint) || 0) / maxFootprint, 1.0);
      const baseRadius = 4 + intensity * 12;
      let color = intensity < 0.2 ? '#3B82F6' :
                  intensity < 0.4 ? '#0EA5E9' :
                  intensity < 0.6 ? '#06B6D4' :
                  intensity < 0.8 ? '#22C55E' :
                  '#F87171';

      const circle = L.circleMarker([p.lat, p.lon], {
        radius: baseRadius,
        color: color,
        fillColor: color,
        fillOpacity: 0.5,
        weight: 1,
        pane: 'markerPane'
      }).addTo(map);

      circle.bindTooltip(`Water footprint: ${p.water_footprint.toFixed(2)} m³/MWh`, {direction:'top'});
      waterMarkers.push({circle, baseRadius, intensity});
    });

    // --- Pulsing animation removed ---
    /*
    if (waterPulseInterval) clearInterval(waterPulseInterval);
    let scaleUp = true;
    waterPulseInterval = setInterval(() => {
      waterMarkers.forEach(obj => {
        const delta = 1 + obj.intensity * 3;
        const maxRadius = obj.baseRadius + 4;
        const newRadius = scaleUp ? Math.min(obj.baseRadius + delta, maxRadius) : obj.baseRadius;
        obj.circle.setRadius(newRadius);
        obj.circle.setStyle({ fillOpacity: 0.4 + 0.2 * obj.intensity });
      });
      scaleUp = !scaleUp;
    }, 800);
    */

    document.getElementById('footer-timestamp').innerText =
      `Updated: ${new Date(data.timestamp).toLocaleString()}`;
    setLegend('water');

  } catch(err) {
    console.error('Error loading water heatmap:', err);
  }
}


async function loadPowerHeatmap() {
  try {
    const res = await fetch('https://data-center-map-nu1d.onrender.com/api/power');
    const data = await res.json();
    const powerData = data.points || [];
    if (powerData.length === 0) return;

    // Clear previous power layer
    clearPowerLayer();

    const maxPower = Math.max(...powerData.map(p => parseFloat(p.total_mwh) || 1));

    // --- HeatLayer commented out ---
    /*
    const heatPoints = powerData.map(p => [p.lat, p.lon, (parseFloat(p.total_mwh) || 0) / maxPower * 0.02]);
    powerHeatLayer = L.heatLayer(heatPoints, {
      radius: 15,
      blur: 15,
      minOpacity: 0.2,
      gradient: {0.0:'#ffff00', 0.5:'#ff8800', 1.0:'#ff0000'}
    }).addTo(map);
    */

    // Add power markers (static)
    powerMarkers = [];
    powerData.forEach(p => {
      const intensity = Math.min((parseFloat(p.total_mwh)||0) / maxPower, 1);
      const baseRadius = 4 + intensity * 10;

      const marker = L.circleMarker([p.lat, p.lon], {
        radius: baseRadius,
        color:'#FACC15',
        fillColor:'#FACC15',
        fillOpacity:0.6,
        weight:1
      }).addTo(map);

      marker.bindTooltip(
        `Power: ${p.total_mwh.toLocaleString()} MWh\nSubbasin: ${p.subbasin}\nFuel: ${p.primary_fuel}`,
        {direction:'top', className:'aqi-tooltip'}
      );

      powerMarkers.push({marker, baseRadius, intensity});
    });

    // --- Pulsing animation removed ---
    /*
    if(powerPulseInterval) clearInterval(powerPulseInterval);
    let scaleUp = true;
    powerPulseInterval = setInterval(() => {
      powerMarkers.forEach(obj => {
        const delta = 1 + obj.intensity * 3;
        const maxRadius = obj.baseRadius + 4;
        const newRadius = scaleUp ? Math.min(obj.baseRadius + delta, maxRadius) : obj.baseRadius;
        obj.marker.setRadius(newRadius);
        obj.marker.setStyle({ fillOpacity: 0.4 + 0.3 * obj.intensity });
      });
      scaleUp = !scaleUp;
    }, 700);
    */

    document.getElementById('footer-timestamp').innerText =
      `Updated: ${new Date(data.timestamp).toLocaleString()}`;

    setLegend('power');
  } catch(err) {
    console.error('Error loading power heatmap:', err);
  }
}



async function loadCarbonHeatmap() {
  try {
    const res = await fetch('https://data-center-map-nu1d.onrender.com/api/carbon');
    const data = await res.json();
    const carbonData = data.points || [];
    if (carbonData.length === 0) return;

    // Remove previous heatLayer & markers
    if (heatLayer) { 
      map.removeLayer(heatLayer); 
      heatLayer = null; 
    }
    carbonMarkers.forEach(m => map.removeLayer(m));
    carbonMarkers = [];

    const maxCarbon = Math.max(...carbonData.map(p => parseFloat(p.carbon_footprint) || 1));

    // --- HeatLayer removed ---
    // const heatPoints = carbonData.map(p => {
    //   const raw = parseFloat(p.carbon_footprint) || 0;
    //   let normalized = (raw / maxCarbon) * 100;
    //   normalized = Math.min(normalized, 1);
    //   return [p.lat, p.lon, normalized];
    // });
    // heatLayer = L.heatLayer(heatPoints, {...}).addTo(map);

    // Add carbon markers (static)
    carbonData.forEach(p => {
      const raw = parseFloat(p.carbon_footprint) || 0;
      let normalized = (raw / maxCarbon) * 100;
      normalized = Math.min(normalized, 1);
      const colorIntensity = `rgba(255,0,0,${0.6 + 0.4*normalized})`;

      const marker = L.circleMarker([p.lat, p.lon], {
        radius: 5,
        fillColor: colorIntensity,
        color: colorIntensity,
        fillOpacity: 0.8,
        weight: 0.5
      }).addTo(map)
        .bindTooltip(`CO₂: ${p.carbon_footprint.toLocaleString()} kg/MWh`, {direction:'top', className:'aqi-tooltip'});

      carbonMarkers.push(marker);
    });

    // --- Pulsing animation removed ---
    /*
    let scaleUp = true;
    setInterval(() => {
      pulseMarkers.forEach(obj => {
        const delta = 2 + obj.intensity*2;
        const maxRadius = obj.baseRadius + 3;
        const newRadius = scaleUp ? Math.min(obj.baseRadius + delta, maxRadius) : obj.baseRadius;
        obj.marker.setRadius(newRadius);
        obj.marker.setStyle({ fillOpacity: 0.5 + 0.3*obj.intensity });
      });
      scaleUp = !scaleUp;
    }, 700);
    */

    document.getElementById('footer-timestamp').innerText =
      `Updated: ${new Date(data.timestamp).toLocaleString()}`;

    setLegend('co2');

  } catch(err) { 
    console.error(err); 
  }
}




// --- Initial Load ---
// Do not load carbon heatmap automatically
loadDataCenters();   // always fine
loadAQIHeatmap();    // initial view is AQI only



// --- Monitor layer radio ---
document.getElementsByName("monitor-layer").forEach(radio=>{
  radio.addEventListener('change', ()=>{
    const label = radio.parentElement.textContent.trim();
    currentPollutant = label.includes("Ozone only")?"ozone":label.includes("PM2.5")?"pm":"all";
    if(currentLayer==="air") loadAQIHeatmap();
  });
});

// --- Nav ribbon (refactored) ---
const panels = {
  monitor: document.getElementById('monitor-panel'),
  insights: document.getElementById('more-insights'),
};

function showPanelsFor(layer) {
    // Toggle main panels
    panels.monitor.style.display = (layer === "air") ? "flex" : "none";
    panels.insights.style.display = (layer === "water" || layer === "co2") ? "flex" : "none";

    // Toggle the map info text box
    const infoBox = document.getElementById('map-info-box');
    if (infoBox) {
        infoBox.style.display = (layer === "air") ? "block" : "none";
    }

    // Remove old projection tabs if they exist
    const projectionTabIds = [
        'water-projection-tab',
        'water-vs-carbon-tab',
        'carbon-projection-tab'
    ];

    projectionTabIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.remove();
    });

    // Add relevant projection tabs
    if (layer === "water") {
        addWaterProjectionTab();
        addWaterVsCarbonTab(); // NEW
    }
    if (layer === "co2") {
        addCarbonProjectionTab();
    }
}





function clearWaterLayer() {
  // Remove heatmap
  if (waterHeatLayer) {
    map.removeLayer(waterHeatLayer);
    waterHeatLayer = null;
  }

  // Remove markers
  if (waterMarkers && waterMarkers.length > 0) {
    waterMarkers.forEach(obj => map.removeLayer(obj.circle));
    waterMarkers = [];
  }

  // Clear animation
  if (waterPulseInterval) {
    clearInterval(waterPulseInterval);
    waterPulseInterval = null;
  }
}

function clearPowerLayer() {
  if(powerHeatLayer) {
    map.removeLayer(powerHeatLayer);
    powerHeatLayer = null;
  }
  if(powerMarkers && powerMarkers.length > 0){
    powerMarkers.forEach(obj => map.removeLayer(obj.marker));
    powerMarkers = [];
  }
  if(powerPulseInterval){
    clearInterval(powerPulseInterval);
    powerPulseInterval = null;
  }
}

function addWaterProjectionTab() {
    // Remove existing tab if already present
    const existingTab = document.getElementById('water-projection-tab');
    if(existingTab) existingTab.remove();

    const tab = document.createElement('div');
    tab.id = 'water-projection-tab';
    tab.className = 'insight-item';
    tab.innerHTML = '<i class="fas fa-water" style="color:#3B82F6;"></i> Water Projections';
    tab.style.cursor = 'pointer';

    tab.addEventListener('click', () => {
        document.getElementById('water-projection-modal').style.display = 'flex';
        loadWaterProjectionChart();
    });

    document.getElementById('more-insights').appendChild(tab);
}

// --- NEW: Water vs Carbon Chart ---
function addWaterVsCarbonTab() {
    const existingTab = document.getElementById('water-vs-carbon-tab');
    if(existingTab) existingTab.remove();

    const tab = document.createElement('div');
    tab.id = 'water-vs-carbon-tab';
    tab.className = 'insight-item';
    tab.innerHTML = '<i class="fas fa-chart-line" style="color:#22C55E;"></i> Water vs Carbon Chart';
    tab.style.cursor = 'pointer';

    tab.addEventListener('click', () => {
    const panel = document.getElementById('insight-graph-panel');
    panel.style.display = 'flex';
    document.getElementById('graph-title').innerText = 'Water vs Carbon Comparison';
    loadWaterBubbleChart();
});


    // Insert after Water Projection tab
    const waterTab = document.getElementById('water-projection-tab');
    if(waterTab) waterTab.insertAdjacentElement('afterend', tab);
    else document.getElementById('more-insights').appendChild(tab);
}

function addCarbonProjectionTab() {
    // Remove existing tab if already present
    const existingTab = document.getElementById('carbon-projection-tab');
    if(existingTab) existingTab.remove();

    const tab = document.createElement('div');
    tab.id = 'carbon-projection-tab';
    tab.className = 'insight-item';
    tab.innerHTML = '<i class="fas fa-cloud" style="color:red;"></i> Carbon Projections';
    tab.style.cursor = 'pointer';

    tab.addEventListener('click', () => {
    const modal = document.getElementById('carbon-projection-modal');
    modal.style.display = 'flex';

    // Give the browser a tick to apply layout before drawing chart
    setTimeout(() => loadCarbonProjectionChart(), 50);
    });


    document.getElementById('more-insights').appendChild(tab);
}


function clearHeatLayer() {
  if (heatLayer) { map.removeLayer(heatLayer); heatLayer = null; }

  // Clear water
  clearWaterLayer();

  // Clear carbon markers
  if (carbonMarkers && carbonMarkers.length > 0) {
    carbonMarkers.forEach(m => map.removeLayer(m));
    carbonMarkers = [];
  }

  // Clear AQI markers
  if (aqiMarkers.length > 0) {
    aqiMarkers.forEach(m => map.removeLayer(m));
    aqiMarkers = [];
  }

  // Clear power markers & heatmap
  clearPowerLayer();

  document.getElementById('footer-timestamp').innerText = "Data layer not implemented yet";
  setLegend(""); // clear legend
}


let carbonLoaded = false; // existing at top of script
let powerLoaded = false;  // new flag for power layer

function loadLayer(layer) {
  switch (layer) {
    case "water":
      loadWaterHeatmap();
      break;
    case "air":
      loadAQIHeatmap();
      break;
    case "co2":
      loadCarbonHeatmap(); // fetch runs every time
      break;
    case "power":
      loadPowerHeatmap();  // fetch power data
      break;
    default:
      clearHeatLayer();
      break;
  }
}



document.querySelectorAll('.nav-item').forEach(item => {
  item.addEventListener('click', () => {
    // Highlight active item
    document.querySelector('.nav-item.active')?.classList.remove('active');
    item.classList.add('active');

    const layer = item.dataset.layer;
    currentLayer = layer;

    showPanelsFor(layer);

    // Clear previous heatmap & markers before loading new layer
    clearHeatLayer();

    loadLayer(layer);
  });
});

// --- More Insights click ---
document.querySelectorAll('#more-insights .insight-item').forEach(item => {
    item.addEventListener('click', () => {
        if (currentLayer !== "water" && currentLayer !== "co2") return;  // allow CO2 too
        const panel = document.getElementById('insight-graph-panel');
        panel.style.display = 'flex';

        // Pass the layer type so loadFuelTypeGraph knows which API to call
        loadFuelTypeGraph(currentLayer);
    });
});


// --- Close Graph Panel ---
document.getElementById('close-graph-panel').addEventListener('click',()=>{
  document.getElementById('insight-graph-panel').style.display='none';
});

// Close Water Projections Modal
document.getElementById('close-water-projection').addEventListener('click', () => {
    document.getElementById('water-projection-modal').style.display = 'none';
});

// Close Carbon Projections Modal
document.getElementById('close-carbon-projection').addEventListener('click', () => {
    document.getElementById('carbon-projection-modal').style.display = 'none';
});


// --- DC Info Tab toggle ---
const dcTab = document.getElementById('dc-info-tab');
dcTab.addEventListener('click',()=>{
  if(dcTab.style.display==='none'||dcTab.style.display==='') dcTab.style.display='flex';
  dcTab.classList.toggle('large');
});
document.getElementById('close-dc-tab').addEventListener('click',e=>{
  e.stopPropagation();
  dcTab.classList.remove('large');
  dcTab.style.display='none';
});

async function loadFuelTypeGraph(layerType = "water") {
    try {
        // Decide which API to call based on layer
        const apiUrl = layerType === "co2"
            ? 'https://data-center-map-nu1d.onrender.com/api/carbon_fuel'
            : 'https://data-center-map-nu1d.onrender.com/api/water_fuel';

        const res = await fetch(apiUrl);
        const data = await res.json();

        const fuelMap = {};
        data.forEach(row => {
            const fuel = row.primary_fuel || 'Unknown';
            const value = layerType === "co2"
                ? parseFloat(row.carbon_footprint) || 0
                : parseFloat(row.water_footprint) || 0;

            if (!fuelMap[fuel]) fuelMap[fuel] = 0;
            fuelMap[fuel] += value;
        });

        const labels = Object.keys(fuelMap);
        const values = Object.values(fuelMap);

        const placeholder = document.getElementById('graph-placeholder');
        placeholder.innerHTML = '<canvas id="fuel-chart"></canvas>';

        const ctx = document.getElementById('fuel-chart').getContext('2d');

        if (window.fuelChart) window.fuelChart.destroy();

        window.fuelChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: layerType === "co2" ? 'Carbon Footprint (kg CO₂)' : 'Water Footprint (m³)',
                    data: values,
                    backgroundColor: ['#FF0000','#FF8800','#FFFF00','#22C55E','#06B6D4','#3B82F6'],
                    borderColor: '#fff',
                    borderWidth: 1,
                    borderRadius: 6,
                    hoverBackgroundColor: ['#FF5555','#FFAA55','#FFFF88','#4ADE80','#22D3EE','#60A5FA'],
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#111827',
                        titleColor: '#6EC1E4',
                        bodyColor: '#fff',
                        titleFont: { weight: '600' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: '#fff', callback: val => val >= 1e6 ? (val/1e6).toFixed(1)+'M' : val },
                        title: { display: true, text: layerType === "co2" ? 'Carbon (kg CO₂)' : 'Water (m³)', color:'#fff' }
                    },
                    x: { ticks: { color: '#fff' } }
                }
            }
        });
    } catch (err) {
        console.error('Error loading fuel type graph', err);
        document.getElementById('graph-placeholder').innerHTML =
            '<div style="color:#ccc; text-align:center;">Failed to load chart.</div>';
    }
}


async function loadWaterProjectionChart() {
    try {
        const res = await fetch('https://data-center-map-nu1d.onrender.com/api/water_scenario');
        const data = await res.json();
        const points = data.points;
        console.log("Water Scenario API returned:", data);

        // --- Group points by year ---
        const yearMap = {};
        points.forEach(p => {
            const year = p.year;
            if (!yearMap[year]) yearMap[year] = { best: null, worst: null };
            if (p.scenario.toLowerCase().includes("best")) yearMap[year].best = p.water_Mm3;
            if (p.scenario.toLowerCase().includes("worst")) yearMap[year].worst = p.water_Mm3;
        });

        // Sort years
        const years = Object.keys(yearMap).sort((a, b) => a - b);

        // Create series arrays
        const bestSeries = years.map(y => yearMap[y].best ?? 0);
        const worstSeries = years.map(y => yearMap[y].worst ?? 0);

        // --- Render Chart.js line chart ---
        const ctx = document.getElementById('waterProjectionChart').getContext('2d');

        // Only destroy if it’s a Chart.js instance
        if (window.waterProjectionChart && window.waterProjectionChart instanceof Chart) {
            window.waterProjectionChart.destroy();
        }


        window.waterProjectionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [
                    {
                        label: 'Best Water Projection',
                        data: bestSeries,
                        borderColor: 'green',
                        fill: false,
                        tension: 0.3
                    },
                    {
                        label: 'Worst Water Projection',
                        data: worstSeries,
                        borderColor: 'red',
                        fill: false,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { labels: { color: '#fff' } },
                    tooltip: {
                        backgroundColor: '#111827',
                        titleColor: '#6EC1E4',
                        bodyColor: '#fff',
                        titleFont: { weight: '600' }
                    }
                },
                scales: {
                    x: { ticks: { color: '#fff' } },
                    y: {
                        ticks: { color: '#fff' },
                        title: { display: true, text: 'Water (Mm³)', color: '#fff' }
                    }
                }
            }
        });

    } catch (err) {
        console.error('Error loading water projection chart', err);
    }
}

async function loadCarbonProjectionChart() {
    try {
        const res = await fetch('https://data-center-map-nu1d.onrender.com/api/carbon_scenario');
        const apiResponse = await res.json(); // 1. Renamed 'data' to 'apiResponse' for clarity
        console.log("Carbon Scenario API returned:", apiResponse); // Check this log!
        const points = apiResponse.data;

        // --- FIX: Add a guard clause here ---
        if (!points || !Array.isArray(points) || points.length === 0) {
            console.error("Carbon data is missing or not an array:", data);
            // Optional: Display a message in the modal instead of a chart
            const chartContainer = document.getElementById('carbonProjectionChart').parentElement;
            chartContainer.innerHTML = '<div style="flex:1; display:flex; align-items:center; justify-content:center; color:#ccc;">No Carbon Projection data available.</div>';
            return; // Stop execution if data is bad or missing
        }

        // --- Group points by year ---
        const yearMap = {};
        points.forEach(p => {
            const year = p.year;
            if (!yearMap[year]) yearMap[year] = { best: null, worst: null };
            if (p.scenario.toLowerCase().includes("best")) yearMap[year].best = p.carbon_MtCO2;
            if (p.scenario.toLowerCase().includes("worst")) yearMap[year].worst = p.carbon_MtCO2;
        });

        // Sort years
        const years = Object.keys(yearMap).sort((a,b)=>a-b);

        // Create series arrays
        const bestSeries = years.map(y => yearMap[y].best ?? 0);
        const worstSeries = years.map(y => yearMap[y].worst ?? 0);

        // --- Render Chart.js line chart ---
        const ctx = document.getElementById('carbonProjectionChart').getContext('2d');

        // Only destroy if it’s a Chart.js instance
        if (window.carbonProjectionChart && window.carbonProjectionChart instanceof Chart) {
            window.carbonProjectionChart.destroy();
        }

        window.carbonProjectionChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: years,
                datasets: [
                    {
                        label: 'Best Carbon Projection',
                        data: bestSeries,
                        borderColor: 'green',
                        fill: false,
                        tension: 0.3
                    },
                    {
                        label: 'Worst Carbon Projection',
                        data: worstSeries,
                        borderColor: 'red',
                        fill: false,
                        tension: 0.3
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,  // important for modal
                plugins: {
                    legend: { labels: { color: '#fff' } },
                    tooltip: {
                        backgroundColor: '#111827',
                        titleColor: '#6EC1E4',
                        bodyColor: '#fff',
                        titleFont: { weight: '600' }
                    }
                },
                scales: {
    x: {
        display: true,
        ticks: {
            color: '#fff',
            font: { size: 12 },

        },
        title: {
            display: true,
            text: 'Year',
            color: '#fff',
            font: { size: 14 },
            padding: { top: 0, bottom: 5 }
        }
    },
    y: {
        display: true,
        ticks: { color: '#fff' },
        title: {
            display: true,
            text: 'Carbon (MtCO₂)',
            color: '#fff'
        }
    }
},
                layout: {
        padding: { bottom: 50}
    }

            }
        });

    } catch(err) {
        console.error('Error loading carbon projection chart', err);
    }
}

async function loadWaterBubbleChart() {
    try {
        const res = await fetch('https://data-center-map-nu1d.onrender.com/api/water_carbon_data');
        const data = await res.json();

        if (!data || data.length === 0) {
            document.getElementById('graph-placeholder').innerHTML =
                '<div style="color:#ccc; text-align:center;">No water/carbon data available.</div>';
            return;
        }

        const maxWater = Math.max(...data.map(d => d.water_footprint));

        const chartData = data.map(d => ({
            x: d.total_mwh,
            y: d.scarcity_factor,
            r: Math.sqrt((d.water_footprint / maxWater * 300) / Math.PI),
            raw: d,  // keep full data for tooltip
            backgroundColor: "rgba(50,50,50,0.7)",
            borderColor: "#fff",
            borderWidth: 1
        }));

        const placeholder = document.getElementById('graph-placeholder');
        placeholder.style.width = '1200px';
        placeholder.style.height = '800px';
        placeholder.innerHTML = '<canvas id="water-bubble-chart"></canvas>';

        const ctx = document.getElementById('water-bubble-chart').getContext('2d');

        if (window.waterBubbleChart) window.waterBubbleChart.destroy();

        window.waterBubbleChart = new Chart(ctx, {
            type: 'bubble',
            data: {
                datasets: [{
                    label: '',
                    data: chartData
                }]
            },
            options: {
                responsive: true,

                interaction: {
                    mode: 'nearest',
                    intersect: true
                },

                plugins: {
                    tooltip: {
                        title: () => '',
                        callbacks: {
                            label: function(context) {
                                const d = context.raw;
                                return `Scarcity: ${d.scarcity_factor}\nMWh: ${d.total_mwh.toLocaleString()}`;
                            }
                        }
                    }
                },

                scales: {
                    x: {
                        type: 'linear',
                        min: 0,
                        max: 2.1e7,
                        title: { display: true, text: 'Electricity used by data centers (MWh)', color: '#fff' },
                        ticks: { color: '#fff' }
                    },
                    y: {
                        min: 0,
                        max: 105,
                        title: { display: true, text: 'Water scarcity factor', color: '#fff' },
                        ticks: { color: '#fff' }
                    }
                }
            }
        });

    } catch (err) {
        console.error(err);
        document.getElementById('graph-placeholder').innerHTML =
            '<div style="color:#ccc; text-align:center;">Failed to load chart.</div>';
    }
}
</script>
</body>
</html>
